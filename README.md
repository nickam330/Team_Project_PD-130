# VK Dating Bot – Функции и описание

Этот документ описывает основные функции VK-бота и их поведение при вызове.

---

## Основные функции

### 1. `add_user_id(user_id, session)`
- **Описание:** Добавляет пользователя в базу данных при первом входе в бота.
- **Входные данные:**
  - `user_id` – ID пользователя VK.
  - `session` – SQLAlchemy-сессия для работы с базой.
- **Возвращает:** ничего.
- **Поведение:**  
  Если пользователя с указанным `user_id` нет в базе, создаётся новая запись с этим ID.

---

### 2. `add_city(user_id, city_name, city_id, session)`
- **Описание:** Сохраняет город пользователя.
- **Входные данные:**
  - `user_id` – ID пользователя VK.
  - `city_name` – название города.
  - `city_id` – идентификатор города в VK.
  - `session` – SQLAlchemy-сессия.
- **Поведение:**  
  Обновляет запись пользователя в базе, добавляя данные о городе.

---

### 3. `add_gender(user_id, gender, session)`
- **Описание:** Сохраняет пол пользователя.
- **Входные данные:**
  - `user_id` – ID пользователя VK.
  - `gender` – строка `"male"` или `"female"`.
  - `session` – SQLAlchemy-сессия.
- **Поведение:**  
  Обновляет поле `gender` в базе данных для указанного пользователя.

---

### 4. `add_age(user_id, age, session)`
- **Описание:** Сохраняет возраст пользователя.
- **Входные данные:**
  - `user_id` – ID пользователя VK.
  - `age` – возраст пользователя.
  - `session` – SQLAlchemy-сессия.
- **Поведение:**  
  Обновляет поле `age` в базе данных для указанного пользователя.

---

### 5. `add_selected(user_id, selected_id, link, session)`
- **Описание:** Добавляет пользователя, которого одобрили, в список выбранных.
- **Входные данные:**
  - `user_id` – ID пользователя, который одобрил кого-то.
  - `selected_id` – ID выбранного пользователя.
  - `link` – ссылка на профиль выбранного пользователя.
  - `session` – SQLAlchemy-сессия.
- **Поведение:**  
  1. Проверяет, существует ли пользователь в базе.  
  2. Проверяет, существует ли уже выбранный пользователь.  
  3. Если выбранный пользователь есть, обновляет ссылку и добавляет в список `selected`.  
  4. Если нет, создаёт новую запись и добавляет в `selected`.  
  5. Сохраняет изменения в базе.

---

### 6. `link_list(user_id, session)`
- **Описание:** Возвращает список ID пользователей, которых уже одобрили.
- **Входные данные:**
  - `user_id` – ID пользователя, для которого выводятся одобренные профили.
  - `session` – SQLAlchemy-сессия.
- **Возвращает:** Список ID (`List[int]`).
- **Поведение:**  
  Берёт пользователя из базы и возвращает ID всех пользователей, находящихся в его списке `selected`.

---

### 7. `add_favourite(user_id, selected_id, session)`
- **Описание:** Добавляет пользователя в избранное.
- **Входные данные:**
  - `user_id` – ID пользователя, который добавляет в избранное.
  - `selected_id` – ID выбранного пользователя.
  - `session` – SQLAlchemy-сессия.
- **Поведение:**  
  Находит связь `user ↔ selected` и ставит флаг `is_favourite = True`.

---

### 8. `show_favourite(user_id, session)`
- **Описание:** Показывает всех пользователей, отмеченных как избранные.
- **Входные данные:**
  - `user_id` – ID пользователя, для которого выводится список избранных.
  - `session` – SQLAlchemy-сессия.
- **Возвращает:** Список ID избранных пользователей.
- **Поведение:**  
  Берёт все записи в `selected`, связанные с пользователем, и фильтрует по `is_favourite = True`.

---

## Принцип работы функций вместе

1. **Добавление пользователя:**  
   При входе нового пользователя вызывается `add_user_id()`.  

2. **Сохранение данных пользователя:**  
   Используются `add_city()`, `add_gender()`, `add_age()`.  

3. **Поиск и одобрение профилей:**  
   - Пользователь видит анкеты других пользователей.  
   - Выбранные профили добавляются через `add_selected()`.  
   - Список всех выбранных профилей можно получить через `link_list()`.  

4. **Работа с избранными:**  
   - Пользователь может отмечать профили как избранные через `add_favourite()`.  
   - Список избранных профилей доступен через `show_favourite()`.

---

## Переменные окружения (.env)

Все чувствительные данные и ключи берутся из файла `.env`:

| Переменная | Описание |
|------------|----------|
| `DATABASE_URL` | URL внешней базы данных (для внешних запросов). |
| `DATABASE_URL_INTERNAL` | URL внутренней базы данных (для внутренних операций). |
| `FERNET_KEY` | Ключ шифрования токенов пользователей. |
| `VK_CLIENT_SECRET` | Секрет приложения VK. |
| `CLIENT_ID` | ID приложения VK. |

---

## Особенности

- **SQLAlchemy ORM:** все функции используют сессию для работы с базой.  
- **Связь «многие ко многим»:** между пользователями и выбранными профилями.  
- **Шифрование токенов:** все токены пользователей (access/refresh) зашифрованы через Fernet.  
- **Flask сервер:** отдельный модуль с точкой входа `app.py`, обрабатывающий маршруты VK OAuth и обмен токенов.  

---

## Схема базы данных


![database diagram](./Screenshot%202025-10-09%20171701.png)

